{% extends "base.html" %}

{% block title %}Real-Time Driver Monitoring - Car Rental System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-eye text-warning"></i> Real-Time Driver Monitoring</h2>
    <div>
        <button id="testCamera" class="btn btn-info me-2">
            <i class="fas fa-video"></i> Test Camera
        </button>
        <button id="testAlarm" class="btn btn-warning me-2">
            <i class="fas fa-volume-up"></i> Test Alarm
        </button>
        <button id="startMonitoring" class="btn btn-success">
            <i class="fas fa-play"></i> Start Monitoring
        </button>
        <button id="stopMonitoring" class="btn btn-danger" disabled>
            <i class="fas fa-stop"></i> Stop Monitoring
        </button>
        <button id="stopAlarm" class="btn btn-secondary" disabled>
            <i class="fas fa-volume-mute"></i> Stop Alarm
        </button>
    </div>
</div>

<!-- Monitoring Status -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4 id="blinkCount">0</h4>
                <p class="mb-0">Total Blinks</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4 id="drowsinessAlerts">0</h4>
                <p class="mb-0">Drowsiness Alerts</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4 id="avgEAR">0.00</h4>
                <p class="mb-0">Avg Eye Aspect Ratio</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4 id="monitoringStatus">Inactive</h4>
                <p class="mb-0">Status</p>
            </div>
        </div>
    </div>
</div>

<!-- Video Feed and Controls -->
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-video text-primary"></i> Live Camera Feed
                </h5>
            </div>
            <div class="card-body">
                <div class="position-relative">
                    <img id="videoFeed" src="" width="100%" height="400" style="background: #000; border-radius: 8px; display: none;">
                    <div id="noVideoMessage" class="text-center py-5" style="background: #000; border-radius: 8px; color: white;">
                        <i class="fas fa-video fa-3x mb-3"></i>
                        <p>Click "Test Camera" to check camera availability</p>
                        <p>Then click "Start Monitoring" to begin real-time detection</p>
                    </div>
                </div>
                
                <!-- Alert Display -->
                <div id="alertDisplay" class="alert alert-danger text-center mt-3" style="display: none;">
                    <h4><i class="fas fa-exclamation-triangle"></i> DROWSINESS DETECTED!</h4>
                    <p class="mb-0">Please take a break or switch drivers immediately.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle text-info"></i> Monitoring Info
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Rental Details:</h6>
                    <p class="mb-1"><strong>Vehicle:</strong> {{ rental.car.make }} {{ rental.car.model }}</p>
                    <p class="mb-1"><strong>Driver:</strong> {{ rental.customer.username }}</p>
                    <p class="mb-1"><strong>Period:</strong> {{ rental.start_date.strftime('%Y-%m-%d') }} to {{ rental.end_date.strftime('%Y-%m-%d') }}</p>
                </div>
                
                <div class="mb-3">
                    <h6>System Status:</h6>
                    <div class="d-flex justify-content-between">
                        <span>Camera:</span>
                        <span id="cameraStatus" class="badge bg-secondary">Not Tested</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Detection:</span>
                        <span id="detectionStatus" class="badge bg-secondary">Inactive</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Face Detection:</span>
                        <span id="faceStatus" class="badge bg-secondary">No Face</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Alarm Status:</span>
                        <span id="alarmStatus" class="badge bg-secondary">Silent</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6>Safety Guidelines:</h6>
                    <ul class="list-unstyled small">
                        <li><i class="fas fa-check text-success"></i> Keep eyes on the road</li>
                        <li><i class="fas fa-check text-success"></i> Take breaks every 2 hours</li>
                        <li><i class="fas fa-check text-success"></i> Stay alert and focused</li>
                        <li><i class="fas fa-check text-success"></i> Pull over if drowsy</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Real-time Chart -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line text-success"></i> Eye Aspect Ratio
                </h5>
                <button id="refreshChart" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <canvas id="earChart" width="300" height="200"></canvas>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Min EAR</small>
                            <div id="minEAR" class="fw-bold">0.00</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Max EAR</small>
                            <div id="maxEAR" class="fw-bold">0.00</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Trend</small>
                            <div id="earTrend" class="fw-bold">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Monitoring History -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history text-secondary"></i> Monitoring Session History
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Session Start</th>
                                <th>Duration</th>
                                <th>Total Blinks</th>
                                <th>Drowsiness Alerts</th>
                                <th>Avg EAR</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="sessionHistory">
                            <!-- Session history will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let monitoringActive = false;
let sessionId = null;
let earChart = null;
let earData = [];
let blinkCount = 0;
let drowsinessAlerts = 0;
let avgEAR = 0.0;
let statusInterval = null;

// Initialize monitoring system
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Chart.js
    const chartCtx = document.getElementById('earChart').getContext('2d');
    earChart = new Chart(chartCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Eye Aspect Ratio',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 0.5
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Event listeners
    document.getElementById('testCamera').addEventListener('click', testCamera);
    document.getElementById('testAlarm').addEventListener('click', testAlarm);
    document.getElementById('startMonitoring').addEventListener('click', startMonitoring);
    document.getElementById('stopMonitoring').addEventListener('click', stopMonitoring);
    document.getElementById('stopAlarm').addEventListener('click', stopAlarm);
    document.getElementById('refreshChart').addEventListener('click', refreshChart);
});

async function testCamera() {
    try {
        const response = await fetch('/api/monitor/camera_test');
        const data = await response.json();
        
        if (data.available) {
            document.getElementById('cameraStatus').textContent = 'Available';
            document.getElementById('cameraStatus').className = 'badge bg-success';
            alert('Camera is working! You can now start monitoring.');
        } else {
            document.getElementById('cameraStatus').textContent = 'Not Available';
            document.getElementById('cameraStatus').className = 'badge bg-danger';
            alert('Camera test failed: ' + data.message);
        }
    } catch (error) {
        console.error('Camera test error:', error);
        alert('Camera test failed: ' + error.message);
    }
}

async function testAlarm() {
    try {
        const response = await fetch('/api/monitor/alarm/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Alarm test failed: ' + data.error);
        } else {
            document.getElementById('alarmStatus').textContent = 'Testing';
            document.getElementById('alarmStatus').className = 'badge bg-warning';
            alert('Alarm test started! You should hear a beep sound.');
            
            // Reset status after 3 seconds
            setTimeout(() => {
                document.getElementById('alarmStatus').textContent = 'Silent';
                document.getElementById('alarmStatus').className = 'badge bg-secondary';
            }, 3000);
        }
    } catch (error) {
        console.error('Alarm test error:', error);
        alert('Alarm test failed: ' + error.message);
    }
}

async function stopAlarm() {
    try {
        const response = await fetch('/api/monitor/alarm/stop', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Failed to stop alarm: ' + data.error);
        } else {
            document.getElementById('alarmStatus').textContent = 'Silent';
            document.getElementById('alarmStatus').className = 'badge bg-secondary';
            document.getElementById('stopAlarm').disabled = true;
        }
    } catch (error) {
        console.error('Stop alarm error:', error);
        alert('Failed to stop alarm: ' + error.message);
    }
}

async function refreshChart() {
    if (!sessionId) return;
    
    try {
        const response = await fetch(`/api/monitor/ear_data/${sessionId}`);
        const data = await response.json();
        
        if (data.error) {
            console.error('Chart refresh error:', data.error);
            return;
        }
        
        // Update chart with new data
        earData = data.ear_history;
        earChart.data.labels = Array.from({length: earData.length}, (_, i) => i);
        earChart.data.datasets[0].data = earData;
        earChart.update('none');
        
        // Update statistics
        const stats = data.statistics;
        document.getElementById('minEAR').textContent = stats.min.toFixed(3);
        document.getElementById('maxEAR').textContent = stats.max.toFixed(3);
        
        const trendElement = document.getElementById('earTrend');
        trendElement.textContent = stats.trend;
        trendElement.className = 'fw-bold ' + (stats.trend === 'increasing' ? 'text-success' : 
                                               stats.trend === 'decreasing' ? 'text-danger' : 'text-info');
        
    } catch (error) {
        console.error('Error refreshing chart:', error);
    }
}

async function startMonitoring() {
    try {
        // Start camera monitoring
        const response = await fetch(`/api/monitor/start_camera/{{ rental.id }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Failed to start monitoring: ' + data.error);
            return;
        }
        
        sessionId = data.session_id;
        
        // Update UI
        document.getElementById('startMonitoring').disabled = true;
        document.getElementById('stopMonitoring').disabled = false;
        document.getElementById('monitoringStatus').textContent = 'Active';
        document.getElementById('detectionStatus').textContent = 'Active';
        document.getElementById('detectionStatus').className = 'badge bg-success';
        
        // Show video feed
        document.getElementById('noVideoMessage').style.display = 'none';
        document.getElementById('videoFeed').style.display = 'block';
        document.getElementById('videoFeed').src = `/api/monitor/video_feed/${sessionId}`;
        
        monitoringActive = true;
        
        // Start status updates
        statusInterval = setInterval(updateStatus, 1000);
        
    } catch (error) {
        console.error('Error starting monitoring:', error);
        alert('Failed to start monitoring: ' + error.message);
    }
}

function stopMonitoring() {
    if (sessionId) {
        fetch(`/api/monitor/stop_camera/${sessionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
    }
    
    // Update UI
    document.getElementById('startMonitoring').disabled = false;
    document.getElementById('stopMonitoring').disabled = true;
    document.getElementById('monitoringStatus').textContent = 'Inactive';
    document.getElementById('detectionStatus').textContent = 'Inactive';
    document.getElementById('detectionStatus').className = 'badge bg-secondary';
    document.getElementById('faceStatus').textContent = 'No Face';
    document.getElementById('faceStatus').className = 'badge bg-secondary';
    
    // Hide video feed
    document.getElementById('videoFeed').style.display = 'none';
    document.getElementById('noVideoMessage').style.display = 'block';
    
    // Stop status updates
    if (statusInterval) {
        clearInterval(statusInterval);
        statusInterval = null;
    }
    
    monitoringActive = false;
}

async function updateStatus() {
    if (!sessionId || !monitoringActive) return;
    
    try {
        const response = await fetch(`/api/monitor/status/${sessionId}`);
        const data = await response.json();
        
        if (data.error) {
            console.error('Status update error:', data.error);
            return;
        }
        
        // Update counters
        blinkCount = data.blink_count;
        drowsinessAlerts = data.drowsy ? drowsinessAlerts + 1 : drowsinessAlerts;
        avgEAR = data.avg_ear;
        
        // Update UI
        document.getElementById('blinkCount').textContent = blinkCount;
        document.getElementById('drowsinessAlerts').textContent = drowsinessAlerts;
        document.getElementById('avgEAR').textContent = avgEAR.toFixed(2);
        
        // Update face detection status
        if (data.face_detected) {
            document.getElementById('faceStatus').textContent = 'Face Detected';
            document.getElementById('faceStatus').className = 'badge bg-success';
        } else {
            document.getElementById('faceStatus').textContent = 'No Face';
            document.getElementById('faceStatus').className = 'badge bg-warning';
        }
        
        // Update drowsiness alert and alarm status
        if (data.drowsy) {
            document.getElementById('alertDisplay').style.display = 'block';
            document.getElementById('videoFeed').style.border = '3px solid #dc3545';
            document.getElementById('videoFeed').style.boxShadow = '0 0 20px #dc3545';
            
            // Update alarm status
            document.getElementById('alarmStatus').textContent = 'Playing';
            document.getElementById('alarmStatus').className = 'badge bg-danger';
            document.getElementById('stopAlarm').disabled = false;
        } else {
            document.getElementById('alertDisplay').style.display = 'none';
            document.getElementById('videoFeed').style.border = 'none';
            document.getElementById('videoFeed').style.boxShadow = 'none';
            
            // Update alarm status
            document.getElementById('alarmStatus').textContent = 'Silent';
            document.getElementById('alarmStatus').className = 'badge bg-success';
            document.getElementById('stopAlarm').disabled = true;
        }
        
        // Update chart
        earData.push(data.ear);
        if (earData.length > 50) {
            earData.shift();
        }
        
        earChart.data.labels = Array.from({length: earData.length}, (_, i) => i);
        earChart.data.datasets[0].data = earData;
        earChart.update('none');
        
    } catch (error) {
        console.error('Error updating status:', error);
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (monitoringActive && sessionId) {
        fetch(`/api/monitor/stop_camera/${sessionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
    }
});
</script>
{% endblock %}
