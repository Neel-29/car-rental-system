{% extends "base.html" %}

{% block title %}Driver Monitoring - Car Rental System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-eye text-warning"></i> Driver Monitoring</h2>
    <div>
        <button id="startSimulation" class="btn btn-success">
            <i class="fas fa-play"></i> Start Simulation
        </button>
        <button id="stopSimulation" class="btn btn-danger" disabled>
            <i class="fas fa-stop"></i> Stop Simulation
        </button>
    </div>
</div>

<!-- Monitoring Status -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4 id="blinkCount">0</h4>
                <p class="mb-0">Total Blinks</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4 id="drowsinessAlerts">0</h4>
                <p class="mb-0">Drowsiness Alerts</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4 id="avgEAR">0.00</h4>
                <p class="mb-0">Avg Eye Aspect Ratio</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4 id="monitoringStatus">Inactive</h4>
                <p class="mb-0">Status</p>
            </div>
        </div>
    </div>
</div>

<!-- Simulation Display -->
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-desktop text-primary"></i> Driver Monitoring Simulation
                </h5>
            </div>
            <div class="card-body">
                <div class="position-relative">
                    <div id="simulationDisplay" class="text-center py-5" style="background: #000; border-radius: 8px; color: white; min-height: 400px;">
                        <i class="fas fa-user fa-5x mb-3"></i>
                        <h4>Driver Monitoring Simulation</h4>
                        <p>Click "Start Simulation" to begin monitoring</p>
                        <div id="eyeStatus" class="mt-3">
                            <i class="fas fa-eye fa-3x text-success" id="eyeIcon"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Alert Display -->
                <div id="alertDisplay" class="alert alert-danger text-center mt-3" style="display: none;">
                    <h4><i class="fas fa-exclamation-triangle"></i> DROWSINESS DETECTED!</h4>
                    <p class="mb-0">Please take a break or switch drivers immediately.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle text-info"></i> Monitoring Info
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6>Rental Details:</h6>
                    <p class="mb-1"><strong>Vehicle:</strong> {{ rental.car.make }} {{ rental.car.model }}</p>
                    <p class="mb-1"><strong>Driver:</strong> {{ rental.customer.username }}</p>
                    <p class="mb-1"><strong>Period:</strong> {{ rental.start_date.strftime('%Y-%m-%d') }} to {{ rental.end_date.strftime('%Y-%m-%d') }}</p>
                </div>
                
                <div class="mb-3">
                    <h6>System Status:</h6>
                    <div class="d-flex justify-content-between">
                        <span>Simulation:</span>
                        <span id="simulationStatus" class="badge bg-secondary">Inactive</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Detection:</span>
                        <span id="detectionStatus" class="badge bg-secondary">Inactive</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Eye Status:</span>
                        <span id="eyeStatusBadge" class="badge bg-secondary">Unknown</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Alarm Status:</span>
                        <span id="alarmStatus" class="badge bg-secondary">Silent</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6>Safety Guidelines:</h6>
                    <ul class="list-unstyled small">
                        <li><i class="fas fa-check text-success"></i> Keep eyes on the road</li>
                        <li><i class="fas fa-check text-success"></i> Take breaks every 2 hours</li>
                        <li><i class="fas fa-check text-success"></i> Stay alert and focused</li>
                        <li><i class="fas fa-check text-success"></i> Pull over if drowsy</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Real-time Chart -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line text-success"></i> Eye Aspect Ratio
                </h5>
                <button id="refreshChart" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <canvas id="earChart" width="300" height="200"></canvas>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Min EAR</small>
                            <div id="minEAR" class="fw-bold">0.00</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Max EAR</small>
                            <div id="maxEAR" class="fw-bold">0.00</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Trend</small>
                            <div id="earTrend" class="fw-bold">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Monitoring History -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history text-secondary"></i> Monitoring Session History
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Session Start</th>
                                <th>Duration</th>
                                <th>Total Blinks</th>
                                <th>Drowsiness Alerts</th>
                                <th>Avg EAR</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="sessionHistory">
                            <!-- Session history will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let simulationActive = false;
let earChart = null;
let earData = [];
let blinkCount = 0;
let drowsinessAlerts = 0;
let avgEAR = 0.0;
let simulationInterval = null;
let statusInterval = null;

// Initialize monitoring system
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Chart.js
    const chartCtx = document.getElementById('earChart').getContext('2d');
    earChart = new Chart(chartCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Eye Aspect Ratio',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 0.5
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Event listeners
    document.getElementById('startSimulation').addEventListener('click', startSimulation);
    document.getElementById('stopSimulation').addEventListener('click', stopSimulation);
    document.getElementById('refreshChart').addEventListener('click', refreshChart);
});

function startSimulation() {
    simulationActive = true;
    
    // Update UI
    document.getElementById('startSimulation').disabled = true;
    document.getElementById('stopSimulation').disabled = false;
    document.getElementById('monitoringStatus').textContent = 'Active';
    document.getElementById('simulationStatus').textContent = 'Active';
    document.getElementById('simulationStatus').className = 'badge bg-success';
    document.getElementById('detectionStatus').textContent = 'Active';
    document.getElementById('detectionStatus').className = 'badge bg-success';
    
    // Start simulation
    simulationInterval = setInterval(simulateDriverBehavior, 2000);
    statusInterval = setInterval(updateStatus, 1000);
}

function stopSimulation() {
    simulationActive = false;
    
    // Update UI
    document.getElementById('startSimulation').disabled = false;
    document.getElementById('stopSimulation').disabled = true;
    document.getElementById('monitoringStatus').textContent = 'Inactive';
    document.getElementById('simulationStatus').textContent = 'Inactive';
    document.getElementById('simulationStatus').className = 'badge bg-secondary';
    document.getElementById('detectionStatus').textContent = 'Inactive';
    document.getElementById('detectionStatus').className = 'badge bg-secondary';
    document.getElementById('eyeStatusBadge').textContent = 'Unknown';
    document.getElementById('eyeStatusBadge').className = 'badge bg-secondary';
    
    // Stop intervals
    if (simulationInterval) {
        clearInterval(simulationInterval);
        simulationInterval = null;
    }
    if (statusInterval) {
        clearInterval(statusInterval);
        statusInterval = null;
    }
    
    // Hide alerts
    document.getElementById('alertDisplay').style.display = 'none';
    document.getElementById('eyeIcon').className = 'fas fa-eye fa-3x text-success';
}

function simulateDriverBehavior() {
    if (!simulationActive) return;
    
    // Simulate random EAR values
    const baseEAR = 0.25;
    const variation = 0.1;
    const ear = baseEAR + (Math.random() - 0.5) * variation;
    
    // Simulate occasional drowsiness
    const isDrowsy = Math.random() < 0.1; // 10% chance
    const finalEAR = isDrowsy ? ear * 0.3 : ear;
    
    // Update EAR data
    earData.push(finalEAR);
    if (earData.length > 50) {
        earData.shift();
    }
    
    // Update chart
    earChart.data.labels = Array.from({length: earData.length}, (_, i) => i);
    earChart.data.datasets[0].data = earData;
    earChart.update('none');
    
    // Update statistics
    const minEAR = Math.min(...earData).toFixed(3);
    const maxEAR = Math.max(...earData).toFixed(3);
    const avgEAR = (earData.reduce((a, b) => a + b, 0) / earData.length).toFixed(3);
    
    document.getElementById('minEAR').textContent = minEAR;
    document.getElementById('maxEAR').textContent = maxEAR;
    
    // Calculate trend
    let trend = 'stable';
    if (earData.length >= 10) {
        const recent = earData.slice(-5);
        const previous = earData.slice(-10, -5);
        const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
        const previousAvg = previous.reduce((a, b) => a + b, 0) / previous.length;
        
        if (recentAvg > previousAvg * 1.05) {
            trend = 'increasing';
        } else if (recentAvg < previousAvg * 0.95) {
            trend = 'decreasing';
        }
    }
    
    const trendElement = document.getElementById('earTrend');
    trendElement.textContent = trend;
    trendElement.className = 'fw-bold ' + (trend === 'increasing' ? 'text-success' : 
                                           trend === 'decreasing' ? 'text-danger' : 'text-info');
    
    // Simulate blink
    if (Math.random() < 0.3) { // 30% chance of blink
        blinkCount++;
        document.getElementById('blinkCount').textContent = blinkCount;
        
        // Animate eye blink
        const eyeIcon = document.getElementById('eyeIcon');
        eyeIcon.className = 'fas fa-eye-slash fa-3x text-warning';
        setTimeout(() => {
            eyeIcon.className = 'fas fa-eye fa-3x text-success';
        }, 200);
    }
    
    // Handle drowsiness
    if (isDrowsy) {
        drowsinessAlerts++;
        document.getElementById('drowsinessAlerts').textContent = drowsinessAlerts;
        document.getElementById('alertDisplay').style.display = 'block';
        document.getElementById('eyeStatusBadge').textContent = 'Drowsy';
        document.getElementById('eyeStatusBadge').className = 'badge bg-danger';
        document.getElementById('alarmStatus').textContent = 'Playing';
        document.getElementById('alarmStatus').className = 'badge bg-danger';
        document.getElementById('eyeIcon').className = 'fas fa-eye-slash fa-3x text-danger';
        
        // Play alarm sound (simulated)
        playAlarmSound();
    } else {
        document.getElementById('alertDisplay').style.display = 'none';
        document.getElementById('eyeStatusBadge').textContent = 'Alert';
        document.getElementById('eyeStatusBadge').className = 'badge bg-success';
        document.getElementById('alarmStatus').textContent = 'Silent';
        document.getElementById('alarmStatus').className = 'badge bg-success';
        document.getElementById('eyeIcon').className = 'fas fa-eye fa-3x text-success';
    }
}

function updateStatus() {
    if (!simulationActive) return;
    
    // Update average EAR
    if (earData.length > 0) {
        avgEAR = earData.reduce((a, b) => a + b, 0) / earData.length;
        document.getElementById('avgEAR').textContent = avgEAR.toFixed(2);
    }
}

function refreshChart() {
    if (earData.length > 0) {
        earChart.data.labels = Array.from({length: earData.length}, (_, i) => i);
        earChart.data.datasets[0].data = earData;
        earChart.update('none');
    }
}

function playAlarmSound() {
    // Create a simple beep sound using Web Audio API
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.5);
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (simulationActive) {
        stopSimulation();
    }
});
</script>
{% endblock %}
