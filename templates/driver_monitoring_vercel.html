{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-eye text-warning"></i> Driver Monitoring - Web Version</h2>
    <div>
        <button id="startSimulation" class="btn btn-success">
            <i class="fas fa-play"></i> Start Simulation
        </button>
        <button id="stopSimulation" class="btn btn-danger" disabled>
            <i class="fas fa-stop"></i> Stop Simulation
        </button>
    </div>
</div>

<!-- Monitoring Status -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-video text-primary"></i> Driver Monitoring
                </h5>
            </div>
            <div class="card-body text-center">
                <div id="simulationDisplay" class="mb-3">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Web Simulation Mode</strong><br>
                        This is a web-based simulation of the driver monitoring system.
                        Real-time camera access is not available in this deployment.
                    </div>
                    <div id="simulationStatus" class="alert alert-secondary">
                        <i class="fas fa-pause"></i> Simulation Stopped
                    </div>
                </div>
                
                <!-- Simulated Video Feed -->
                <div id="simulatedVideo" class="border rounded p-4 mb-3" style="background: linear-gradient(45deg, #f0f0f0, #e0e0e0); min-height: 300px; display: flex; align-items: center; justify-content: center;">
                    <div class="text-center">
                        <i class="fas fa-video fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Simulated Camera Feed</p>
                        <div id="simulationData" class="small text-muted">
                            <div>EAR: <span id="simEAR">0.000</span></div>
                            <div>Blinks: <span id="simBlinks">0</span></div>
                            <div>Status: <span id="simStatus">Normal</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar text-success"></i> Monitoring Stats
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Blink Count:</span>
                    <span id="blinkCount" class="badge bg-primary">0</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Drowsiness:</span>
                    <span id="drowsinessStatus" class="badge bg-success">No</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>EAR Value:</span>
                    <span id="earValue" class="badge bg-info">0.000</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Simulation:</span>
                    <span id="simulationStatus" class="badge bg-secondary">Stopped</span>
                </div>
            </div>
        </div>
        
        <!-- Real-time Chart -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line text-success"></i> Eye Aspect Ratio
                </h5>
            </div>
            <div class="card-body">
                <canvas id="earChart" width="300" height="200"></canvas>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Min EAR</small>
                            <div id="minEAR" class="fw-bold">0.000</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Max EAR</small>
                            <div id="maxEAR" class="fw-bold">0.000</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Trend</small>
                            <div id="earTrend" class="fw-bold">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drowsiness Alert -->
<div id="alertDisplay" class="alert alert-danger text-center" style="display: none;">
    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
    <h4>⚠️ DROWSINESS DETECTED ⚠️</h4>
    <p class="mb-0">Please take a break and rest!</p>
</div>

<!-- Rental Information -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fas fa-car text-primary"></i> Rental Information
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Car:</strong> {{ rental.car.make }} {{ rental.car.model }} ({{ rental.car.year }})</p>
                <p><strong>License Plate:</strong> {{ rental.car.license_plate }}</p>
                <p><strong>Daily Rate:</strong> ${{ "%.2f"|format(rental.car.daily_rate) }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Start Date:</strong> {{ rental.start_date.strftime('%Y-%m-%d') }}</p>
                <p><strong>End Date:</strong> {{ rental.end_date.strftime('%Y-%m-%d') }}</p>
                <p><strong>Total Cost:</strong> ${{ "%.2f"|format(rental.total_cost) }}</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let simulationInterval = null;
let earData = [];
let blinkCount = 0;
let drowsinessDetected = false;
let earChart;

// Initialize Chart.js
document.addEventListener('DOMContentLoaded', function() {
    const chartCtx = document.getElementById('earChart').getContext('2d');
    earChart = new Chart(chartCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Eye Aspect Ratio (EAR)',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                borderWidth: 2,
                tension: 0.1,
                fill: true,
                pointRadius: 2,
                pointHoverRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Time (seconds)'
                    }
                },
                y: {
                    beginAtZero: true,
                    max: 0.5,
                    title: {
                        display: true,
                        text: 'EAR Value'
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
    
    // Event listeners
    document.getElementById('startSimulation').addEventListener('click', startSimulation);
    document.getElementById('stopSimulation').addEventListener('click', stopSimulation);
});

function startSimulation() {
    if (simulationInterval) return;
    
    document.getElementById('startSimulation').disabled = true;
    document.getElementById('stopSimulation').disabled = false;
    document.getElementById('simulationStatus').textContent = 'Running';
    document.getElementById('simulationStatus').className = 'badge bg-success';
    
    // Reset data
    earData = [];
    blinkCount = 0;
    drowsinessDetected = false;
    
    // Start simulation
    simulationInterval = setInterval(() => {
        // Generate realistic EAR data
        const baseEAR = 0.25 + Math.random() * 0.1; // Base EAR between 0.25-0.35
        const variation = (Math.random() - 0.5) * 0.05; // ±0.025 variation
        const ear = Math.max(0.1, Math.min(0.4, baseEAR + variation));
        
        // Simulate occasional blinks (EAR drops)
        if (Math.random() < 0.1) { // 10% chance of blink
            const blinkEAR = ear * 0.3; // Blink reduces EAR to 30%
            earData.push(blinkEAR);
            blinkCount++;
            document.getElementById('simBlinks').textContent = blinkCount;
        } else {
            earData.push(ear);
        }
        
        // Simulate drowsiness (sustained low EAR)
        if (ear < 0.2 && Math.random() < 0.3) { // 30% chance if EAR is low
            drowsinessDetected = true;
            document.getElementById('simStatus').textContent = 'Drowsy';
            document.getElementById('simStatus').className = 'text-danger';
            document.getElementById('alertDisplay').style.display = 'block';
            document.getElementById('simulatedVideo').style.border = '3px solid #dc3545';
            document.getElementById('simulatedVideo').style.boxShadow = '0 0 20px #dc3545';
        } else if (ear > 0.25) {
            drowsinessDetected = false;
            document.getElementById('simStatus').textContent = 'Normal';
            document.getElementById('simStatus').className = 'text-success';
            document.getElementById('alertDisplay').style.display = 'none';
            document.getElementById('simulatedVideo').style.border = 'none';
            document.getElementById('simulatedVideo').style.boxShadow = 'none';
        }
        
        // Update display
        document.getElementById('simEAR').textContent = ear.toFixed(3);
        document.getElementById('blinkCount').textContent = blinkCount;
        document.getElementById('drowsinessStatus').textContent = drowsinessDetected ? 'Yes' : 'No';
        document.getElementById('drowsinessStatus').className = drowsinessDetected ? 'badge bg-danger' : 'badge bg-success';
        document.getElementById('earValue').textContent = ear.toFixed(3);
        
        // Update chart
        if (earData.length > 50) {
            earData.shift();
        }
        
        earChart.data.labels = Array.from({length: earData.length}, (_, i) => i);
        earChart.data.datasets[0].data = earData;
        earChart.update('none');
        
        // Update statistics
        if (earData.length > 0) {
            const minEAR = Math.min(...earData).toFixed(3);
            const maxEAR = Math.max(...earData).toFixed(3);
            
            document.getElementById('minEAR').textContent = minEAR;
            document.getElementById('maxEAR').textContent = maxEAR;
            
            // Calculate trend
            let trend = 'stable';
            if (earData.length >= 10) {
                const recent = earData.slice(-5);
                const previous = earData.slice(-10, -5);
                const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
                const previousAvg = previous.reduce((a, b) => a + b, 0) / previous.length;
                
                if (recentAvg > previousAvg * 1.05) {
                    trend = 'increasing';
                } else if (recentAvg < previousAvg * 0.95) {
                    trend = 'decreasing';
                }
            }
            
            const trendElement = document.getElementById('earTrend');
            trendElement.textContent = trend;
            trendElement.className = 'fw-bold ' + (trend === 'increasing' ? 'text-success' : 
                                                   trend === 'decreasing' ? 'text-danger' : 'text-info');
        }
        
    }, 1000); // Update every second
}

function stopSimulation() {
    if (simulationInterval) {
        clearInterval(simulationInterval);
        simulationInterval = null;
    }
    
    document.getElementById('startSimulation').disabled = false;
    document.getElementById('stopSimulation').disabled = true;
    document.getElementById('simulationStatus').textContent = 'Stopped';
    document.getElementById('simulationStatus').className = 'badge bg-secondary';
    
    // Reset display
    document.getElementById('simStatus').textContent = 'Stopped';
    document.getElementById('simStatus').className = 'text-muted';
    document.getElementById('alertDisplay').style.display = 'none';
    document.getElementById('simulatedVideo').style.border = 'none';
    document.getElementById('simulatedVideo').style.boxShadow = 'none';
}
</script>
{% endblock %}
